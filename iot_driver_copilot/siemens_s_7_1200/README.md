Siemens S7-1200 PLC HTTP Driver (Golang)

This driver connects to a Siemens S7-1200 PLC (S7comm over TCP/102) and exposes a minimal HTTP API to configure, connect, and read/write PLC Data Blocks (DB). It actively manages the S7 connection with retry and exponential backoff and serves data over HTTP without exposing native protocol URLs.

Build and Run

- Requirements: Go 1.20+, network reachability to the PLC (TCP 102 open), PLC configured with static IP and Full access, relevant DBs created in the PLC program.

1) Set required environment variables:
- HTTP_HOST: HTTP bind host (e.g., 0.0.0.0)
- HTTP_PORT: HTTP bind port (e.g., 8080)

Optional environment variables (used if set):
- PLC_IP: Initial PLC IP address
- PLC_RACK: Initial rack (usually 0)
- PLC_SLOT: Initial slot (often 1)
- PLC_TIMEOUT_MS: Operation timeout in ms (default 2000)
- CONNECT_BACKOFF_MS_INITIAL: Initial reconnect backoff in ms (default 500)
- CONNECT_BACKOFF_MS_MAX: Max reconnect backoff in ms (default 10000)
- CONNECT_RETRY_MAX: Max consecutive retries before backing off at max (0 = unlimited)
- READ_TIMEOUT_MS: DB read timeout in ms (default 2000)
- WRITE_TIMEOUT_MS: DB write timeout in ms (default 2000)

2) Build and run:
- go build -o s7driver
- ./s7driver

Alternatively: go run .

HTTP API

- PUT /plc/config
  Set or update PLC connection parameters.
  Body JSON fields (all optional; omitted fields remain unchanged):
  { "ip": "192.168.1.10", "rack": 0, "slot": 1, "port": 102, "timeout_ms": 2000 }

- POST /plc/connect
  Open session to the PLC using last configured parameters.

- GET /plc/status
  Returns connection state and last error.

- POST /plc/disconnect
  Gracefully close the PLC session.

- GET /db/read?db=1&start=0&size=8
  Read raw bytes from a DB. Response contains hex-encoded data.

- POST /db/write
  Body: { "db": 1, "start": 0, "data": "01020304" }  // data is hex
  Write raw bytes to a DB.

Quickstart (example curl commands)

- Configure PLC target:
  curl -X PUT http://localhost:8080/plc/config \
    -H 'Content-Type: application/json' \
    -d '{"ip":"192.168.1.10","rack":0,"slot":1,"timeout_ms":2000}'

- Connect:
  curl -X POST http://localhost:8080/plc/connect

- Check status:
  curl http://localhost:8080/plc/status

- Read 8 bytes from DB1 at offset 0:
  curl 'http://localhost:8080/db/read?db=1&start=0&size=8'

- Write 4 bytes (0x01 0x02 0x03 0x04) to DB1 at offset 0:
  curl -X POST http://localhost:8080/db/write \
    -H 'Content-Type: application/json' \
    -d '{"db":1,"start":0,"data":"01020304"}'

Notes

- The driver maintains a background connection loop with exponential backoff, timeouts, and retry limits. If the PLC disconnects, it will attempt to reconnect while the session is desired (after /plc/connect).
- Data returned from /db/read is hex-encoded; decode on the client for typed values.
- Ensure the PLC has the proper DBs and that access level is Full access in the TIA Portal project.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
