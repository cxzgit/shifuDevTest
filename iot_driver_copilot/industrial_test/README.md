Industrial Environmental Sensor Modbus RTU to HTTP Driver (C++)

Overview
- Connects to an RS-485 Modbus RTU environmental sensor and exposes a lightweight HTTP API.
- Periodically polls holding registers (function 0x03) for temperature, humidity, and CO2.
- Converts raw Modbus RTU data to JSON over HTTP.

Build
- Requirements: g++ (C++17), POSIX system (Linux recommended) with RS-485/serial access.
- Compile:
  g++ -std=c++17 -O2 -pthread driver.cpp -o driver

Run
- Ensure the required environment variables are set (see below).
- Start the driver (runs HTTP server):
  HTTP_HOST=0.0.0.0 HTTP_PORT=8080 MODBUS_PORT=/dev/ttyUSB0 MODBUS_SLAVE_ID=1 \
  TEMP_REG_ADDR=0 HUM_REG_ADDR=1 CO2_REG_ADDR=2 \
  ./driver

Environment Variables
HTTP server
- HTTP_HOST: Interface to bind (default: 0.0.0.0)
- HTTP_PORT: TCP port (default: 8080)

Modbus/Serial link
- MODBUS_PORT: Serial device path (e.g., /dev/ttyUSB0). Required.
- MODBUS_SLAVE_ID: Sensor Slave ID (1â€“247). Required.
- MODBUS_BAUD: Baud rate (default: 9600). Supported: 1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200.
- MODBUS_DATA_BITS: Data bits (default: 8)
- MODBUS_PARITY: Parity N/E/O (default: N)
- MODBUS_STOP_BITS: Stop bits (default: 1)
- MODBUS_TIMEOUT_MS: Per-request timeout in ms (default: 1000)

Polling and resilience
- POLL_INTERVAL_MS: Initial poll interval in ms (default: 1000)
- BACKOFF_INITIAL_MS: Initial backoff on error in ms (default: 500)
- BACKOFF_MAX_MS: Maximum backoff on error in ms (default: 5000)

Register mapping per measurement
- TEMP_REG_ADDR: Start address for temperature (Required)
- TEMP_REG_COUNT: Number of registers (1 or 2, default: 1)
- TEMP_TYPE: Data type (uint16, int16, uint32, int32, float32; default: uint16)
- TEMP_ENDIAN: Word order for 32-bit types be/le (default: be)
- TEMP_SCALE: Multiplier applied to parsed value (default: 1.0)

- HUM_REG_ADDR: Start address for humidity (Required)
- HUM_REG_COUNT: Number of registers (1 or 2, default: 1)
- HUM_TYPE: Data type (uint16, int16, uint32, int32, float32; default: uint16)
- HUM_ENDIAN: Word order for 32-bit types be/le (default: be)
- HUM_SCALE: Multiplier applied to parsed value (default: 1.0)

- CO2_REG_ADDR: Start address for CO2 (Required)
- CO2_REG_COUNT: Number of registers (1 or 2, default: 1)
- CO2_TYPE: Data type (uint16, int16, uint32, int32, float32; default: uint16)
- CO2_ENDIAN: Word order for 32-bit types be/le (default: be)
- CO2_SCALE: Multiplier applied to parsed value (default: 1.0)

HTTP API
- POST /connect
  Open the serial port and set Modbus RTU parameters using environment variables. Does not start polling.
  Example: curl -X POST http://localhost:8080/connect

- POST /poll/start
  Begin continuous polling of the configured registers via Modbus function 0x03.
  Example: curl -X POST http://localhost:8080/poll/start

- POST /poll/stop
  Halt polling loop (keeps serial link open).
  Example: curl -X POST http://localhost:8080/poll/stop

- POST /disconnect
  Stop polling and close the serial port.
  Example: curl -X POST http://localhost:8080/disconnect

- PUT /config/polling
  Update the poll interval for subsequent cycles. Body: {"interval_ms": 1000}
  Example: curl -X PUT http://localhost:8080/config/polling -H 'Content-Type: application/json' -d '{"interval_ms":1500}'

- GET /readings
  Return the latest parsed readings and timestamp.
  Example: curl http://localhost:8080/readings

- GET /status
  Driver and link status, last poll timestamp, last error, and current poll interval.
  Example: curl http://localhost:8080/status

Notes
- The driver implements Modbus RTU CRC16, function code 0x03, and per-request timeouts.
- On polling errors, it retries with exponential backoff up to BACKOFF_MAX_MS.
- Latest readings are kept in-memory for quick GET /readings responses.
- All configuration is provided via environment variables; API allows runtime poll interval adjustments only (non-persistent).

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)