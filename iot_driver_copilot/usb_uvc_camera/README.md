USB UVC Camera HTTP Driver (Golang)

Overview
- This driver connects to a USB UVC camera via the Linux V4L2 API and exposes a minimal HTTP API to control streaming and capture snapshots.
- It actively ingests frames from the device using V4L2 MMAP and proxies them over HTTP.

Build and Run
1) Requirements: Linux, Go 1.20+, a UVC camera at /dev/videoX.
2) Build:
   go build -o uvc-driver
3) Run:
   HTTP_HOST=0.0.0.0 HTTP_PORT=8080 \
   CAM_DEVICE=/dev/video0 CAM_WIDTH=640 CAM_HEIGHT=480 CAM_FRAME_RATE=30 CAM_PIXEL_FORMAT=MJPEG \
   AUTOSTART=true RETRY_BASE_MS=250 RETRY_MAX_MS=5000 CAPTURE_TIMEOUT_MS=1000 MMAP_BUFFERS=4 \
   ./uvc-driver

Environment Variables
- HTTP_HOST: HTTP server bind address (default: 0.0.0.0)
- HTTP_PORT: HTTP server port (default: 8080)
- CAM_DEVICE: Camera device path (e.g., /dev/video0)
- CAM_WIDTH: Capture width (e.g., 640, 1280, 1920)
- CAM_HEIGHT: Capture height (e.g., 480, 720, 1080)
- CAM_FRAME_RATE: Target frames per second (e.g., 15, 30, 60)
- CAM_PIXEL_FORMAT: MJPEG or YUYV (default: MJPEG)
- AUTOSTART: true/false to auto start streaming on service init (default: false)
- RETRY_BASE_MS: Initial backoff in ms when reconnecting (default: 250)
- RETRY_MAX_MS: Maximum backoff in ms (default: 5000)
- CAPTURE_TIMEOUT_MS: Wait timeout in ms for a frame dequeue (default: 1000)
- MMAP_BUFFERS: Number of MMAP buffers to use (min 2, default: 4)

HTTP API
- POST /stream/start
  Open and start continuous capture using current config.
- POST /stream/stop
  Stop continuous capture and release the device.
- PUT /config
  Update config idempotently. Stops must be performed before changing config.
  JSON body fields (all optional): device, width, height, frame_rate, pixel_format, autostart.
- GET /status
  Returns current configuration and streaming state in JSON.
- GET /snapshot
  Returns a single frame. Content-Type is image/jpeg for MJPEG; for YUYV it's application/octet-stream.
- GET /stream
  Serves a live MJPEG multipart stream. Requires pixel_format=MJPEG and streaming active.

Quick Examples
- Start stream:
  curl -X POST http://localhost:8080/stream/start
- Check status:
  curl http://localhost:8080/status
- Change config to 1280x720 MJPEG 30fps:
  curl -X PUT http://localhost:8080/config -H 'Content-Type: application/json' \
       -d '{"width":1280,"height":720,"frame_rate":30,"pixel_format":"MJPEG"}'
- Capture a snapshot:
  curl http://localhost:8080/snapshot --output frame.jpg
- View stream in browser:
  Open http://localhost:8080/stream (requires MJPEG)

Notes
- Some UVC devices may not support changing FPS via VIDIOC_S_PARM; the driver logs errors and retries.
- For /stream (multipart MJPEG), ensure CAM_PIXEL_FORMAT or /config pixel_format is set to MJPEG.
- If you need to change format/resolution, stop streaming first via /stream/stop.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
