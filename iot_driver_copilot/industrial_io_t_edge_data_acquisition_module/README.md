Industrial IoT Edge DAQ Module Driver (HTTP)

Overview
- This driver connects to the Industrial IoT Edge Data Acquisition Module using its native Modbus TCP protocol to continuously acquire real-time I/O data in the background. It also optionally connects to the device via MQTT to configure the device's MQTT publish interval. The driver exposes a small HTTP API for configuration and status checks.
- It implements a resilient collection loop with timeouts, retries, and exponential backoff, maintains a thread-safe buffer with the latest samples, logs key events, and shuts down gracefully.

Build and Run
1) Set environment variables (see below)
2) Build:
   go build -o daq-driver
3) Run:
   ./daq-driver

Required Environment Variables
- MODBUS_TCP_ADDR: Modbus TCP address of the device (host:port), e.g. 192.168.1.50:502

HTTP Server Configuration
- HTTP_HOST: Interface to bind (default: 0.0.0.0)
- HTTP_PORT: Port to listen on (default: 8080)

Modbus Acquisition Configuration
- MODBUS_UNIT_ID: Modbus unit/slave ID (default: 1)
- REQUEST_TIMEOUT_MS: Per-request timeout in ms (default: 1000)
- ACQ_INTERVAL_MS: Acquisition interval in ms for polling (default: 200)
- BACKOFF_INITIAL_MS: Initial reconnect backoff in ms (default: 500)
- BACKOFF_MAX_MS: Maximum reconnect backoff in ms (default: 10000)
- BUFFER_SIZE: Ring buffer capacity for recent samples (default: 256)
- ONLINE_TTL_SEC: Consider device online if last successful read occurred within this many seconds (default: 5)

Optional: Configure Publish Interval via Modbus
- MODBUS_PUB_INTERVAL_REG: Holding register address (decimal) to write the publish interval to. Writes a single 16-bit value.
- MODBUS_PUB_INTERVAL_SCALE: Scale factor applied to interval_ms before writing to the register (default: 1). For example, set to 10 if the register expects tens of milliseconds. Note: interval_ms/scale must fit in 0..65535.

Optional: Configure Publish Interval via MQTT
- MQTT_BROKER: MQTT broker URL (e.g., tcp://localhost:1883). If set, the driver will establish an MQTT connection for configuration.
- MQTT_CLIENT_ID: MQTT client ID (default: daq-driver)
- MQTT_USERNAME: MQTT username (optional)
- MQTT_PASSWORD: MQTT password (optional)
- MQTT_COMMAND_TOPIC: MQTT topic to publish the configuration command to (e.g., device/cmd/config). The driver sends a JSON payload: {"interval_ms": <int>} with QoS 1.

Exposed HTTP APIs
- GET /status
  Returns overall device health and connectivity, including network (online/offline), MQTT link status, acquisition state (running/stopped), buffer fill level, and last-update timestamp.
  Example:
    curl -s http://localhost:8080/status | jq .

- PUT /config/publish
  Configures MQTT data publishing interval for the device. The driver will use MQTT if MQTT_BROKER and MQTT_COMMAND_TOPIC are set. Otherwise, if MODBUS_PUB_INTERVAL_REG is set, it will write the interval to that Modbus register. Body must be JSON: {"interval_ms": 1000}
  Examples:
    Using MQTT:
      curl -X PUT http://localhost:8080/config/publish \
        -H 'Content-Type: application/json' \
        -d '{"interval_ms": 1000}'
    Using Modbus register:
      curl -X PUT http://localhost:8080/config/publish \
        -H 'Content-Type: application/json' \
        -d '{"interval_ms": 500}'

Notes
- Data acquisition is performed in the background and is not directly exposed via HTTP endpoints, but it informs status and readiness.
- The driver never exposes native protocol endpoints; it converts device communication into a simple HTTP interface.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
