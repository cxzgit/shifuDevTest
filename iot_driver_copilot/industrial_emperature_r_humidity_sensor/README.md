Industrial Temperature & Humidity Modbus RTU Driver (HTTP Proxy)

Overview
- Connects to a Modbus RTU sensor via USB/RS485 (e.g., /dev/ttyUSB0)
- Actively polls temperature and humidity registers on the device
- Exposes HTTP endpoints that return the latest telemetry values as JSON
- Implements retry with exponential backoff, thread-safe buffer, and graceful shutdown

HTTP Endpoints
- GET /temperature -> {"value": <number>} (returns latest temperature)
- GET /humidity    -> {"value": <number>} (returns latest humidity)

Configuration (Environment Variables)
- HTTP_HOST: HTTP server host (default: 0.0.0.0)
- HTTP_PORT: HTTP server port (default: 8080)
- SERIAL_PORT: Serial device path (default: /dev/ttyUSB0)
- BAUD_RATE: Serial baud rate (default: 9600)
- DATA_BITS: Serial data bits (default: 8)
- PARITY: Serial parity (N/E/O) (default: N)
- STOP_BITS: Serial stop bits (default: 1)
- SLAVE_ID or DEVICE_ADDRESS: Modbus slave ID/address (default: 1)
- TIMEOUT_MS: Modbus timeout in ms or Go duration (e.g., 5000ms) (default: 5000ms)
- POLL_INTERVAL_MS: Polling interval in ms (default: 1000ms)
- TEMP_REGISTER: Register address for temperature (default: 0)
- TEMP_FUNC: Register function for temperature: input or holding (default: input)
- TEMP_SCALE: Scaling factor applied to raw temperature (default: 1.0)
- HUM_REGISTER: Register address for humidity (default: 1)
- HUM_FUNC: Register function for humidity: input or holding (default: input)
- HUM_SCALE: Scaling factor applied to raw humidity (default: 1.0)
- MAX_STALENESS_MS: Max allowed staleness of last sample before returning error (default: 15000ms)
- BACKOFF_BASE_MS: Base backoff on connection/read failure (default: 500ms)
- BACKOFF_MAX_MS: Max backoff on connection/read failure (default: 10000ms)
- LOG_LEVEL: logging level: debug | info | warn | error (default: info)

Build and Run
- Ensure your container/system has access to the serial device. In Docker, you may need privileged mode and mount the device:

  docker run --rm -it \
    --privileged \
    --device /dev/ttyUSB0 \
    -e SERIAL_PORT=/dev/ttyUSB0 \
    -e BAUD_RATE=9600 \
    -e PARITY=N \
    -e STOP_BITS=1 \
    -e SLAVE_ID=1 \
    -e TEMP_REGISTER=0 \
    -e HUM_REGISTER=1 \
    -p 8080:8080 \
    <your-image>

- Local build:

  go build -o driver ./
  ./driver

Quick Test
- Temperature: curl http://localhost:8080/temperature
- Humidity:    curl http://localhost:8080/humidity

Notes
- Register addresses and function codes depend on your specific sensor model; set TEMP_REGISTER/HUM_REGISTER and TEMP_FUNC/HUM_FUNC accordingly.
- Scaling (TEMP_SCALE/HUM_SCALE) converts raw register values to physical units if the device requires it.
- The driver polls in background and returns the latest sample; on serial/Modbus errors or stale data, endpoints respond with HTTP 503 and a JSON error.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
