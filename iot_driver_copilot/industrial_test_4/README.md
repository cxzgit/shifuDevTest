Industrial Modbus RTU Environmental Sensor Driver (HTTP)

This driver connects to an industrial environmental sensor over Modbus RTU (RS-485, 9600 baud, 8N1), periodically polls holding registers via function code 0x03, and exposes a minimal HTTP API to manage the connection and observe status and latest readings.

Requirements
- Python 3.8+
- RS-485/serial interface accessible by the host system
- The sensor must support Modbus RTU function 0x03 for the specified registers

Install
- Create and activate a virtual environment (optional)
- Install dependencies:
  pip install -r requirements.txt

Environment Variables (required)
- HTTP_HOST: Host/IP for the HTTP server (e.g., 0.0.0.0)
- HTTP_PORT: Port for the HTTP server (e.g., 8000)
- MODBUS_PORT: Serial port for RS-485 (e.g., /dev/ttyUSB0 or COM3)
- MODBUS_SLAVE_ID: Modbus unit ID (1–247)
- POLL_INTERVAL_MS: Polling interval in milliseconds (e.g., 1000)
- MODBUS_TIMEOUT_S: Modbus request timeout in seconds (e.g., 1.5)
- RETRY_MAX: Consecutive read errors before forcing reconnect (e.g., 3)
- BACKOFF_INITIAL_MS: Initial reconnect backoff in ms (e.g., 500)
- BACKOFF_MAX_MS: Maximum reconnect backoff in ms (e.g., 10000)
- REG_TEMPERATURE_ADDR: Holding register address for temperature (e.g., 100)
- REG_HUMIDITY_ADDR: Holding register address for humidity (e.g., 101)
- REG_CO2_ADDR: Holding register address for CO₂ (e.g., 102)
- SCALE_TEMPERATURE: Multiplicative scale applied to raw temperature (e.g., 0.1)
- SCALE_HUMIDITY: Multiplicative scale applied to raw humidity (e.g., 0.1)
- SCALE_CO2: Multiplicative scale applied to raw CO₂ (e.g., 1.0)

Notes
- The driver does not hard-code device-specific addresses or scaling. You must provide them via environment variables.
- The serial link uses 9600 baud, 8 data bits, no parity, 1 stop bit (8N1), and function code 0x03 to read holding registers.

Run
- Export environment variables (example):
  export HTTP_HOST=0.0.0.0
  export HTTP_PORT=8000
  export MODBUS_PORT=/dev/ttyUSB0
  export MODBUS_SLAVE_ID=1
  export POLL_INTERVAL_MS=1000
  export MODBUS_TIMEOUT_S=1.5
  export RETRY_MAX=3
  export BACKOFF_INITIAL_MS=500
  export BACKOFF_MAX_MS=10000
  export REG_TEMPERATURE_ADDR=100
  export REG_HUMIDITY_ADDR=101
  export REG_CO2_ADDR=102
  export SCALE_TEMPERATURE=0.1
  export SCALE_HUMIDITY=0.1
  export SCALE_CO2=1.0

- Start the driver:
  python3 driver.py

HTTP API
- POST /connect
  Purpose: Open the RS‑485 serial connection and start polling. Body parameters are optional; if omitted, the driver uses environment variables. If already connected to the same target, this is a no-op.
  Example:
  curl -X POST http://localhost:8000/connect -H 'Content-Type: application/json' -d '{"port":"/dev/ttyUSB0","slave_id":1}'

- GET /status
  Purpose: Check connection and polling status, latest timestamps, last error, and the latest sensor readings (temperature, humidity, CO₂).
  Example:
  curl http://localhost:8000/status

Security
- This simple driver exposes no authentication; place it behind appropriate network controls if required.

Graceful Shutdown
- Ctrl+C or SIGTERM cleanly stops background polling and closes the serial connection.

License
- For demonstration and integration purposes.

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
