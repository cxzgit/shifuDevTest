THS-1000 Modbus RTU Temperature/Humidity Driver (Go)

This driver connects to a Modbus RTU ambient temperature and humidity sensor (RS‑485), continuously polls raw holding registers, converts values into human-readable metrics, and exposes them via an HTTP endpoint.

Features
- Modbus RTU over serial (RS‑485) using function 0x03 (Read Holding Registers)
- Continuous background polling of temperature, humidity, and sample-interval registers
- Scaling of 16-bit raw values: value × 0.01 for °C and %RH by default
- Resilient collection loop: timeouts, retries, exponential backoff, and auto-reconnect
- Thread-safe buffered latest sample
- HTTP endpoint: GET /status returning connection state, latest readings, error counters, and timestamps

Configuration (Environment Variables)
- HTTP_HOST: HTTP server bind host (default: 0.0.0.0)
- HTTP_PORT: HTTP server port (default: 8080)
- SERIAL_PORT: Serial port device path (default: /dev/ttyUSB0)
- SERIAL_BAUD: Baud rate (default: 9600)
- SERIAL_DATA_BITS: Data bits (default: 8)
- SERIAL_PARITY: Parity (N/E/O, default: N)
- SERIAL_STOP_BITS: Stop bits (1/2, default: 1)
- SERIAL_READ_CHUNK_MS: Serial read chunk timeout in milliseconds for internal reads (default: 50)
- MODBUS_SLAVE_ID: Modbus RTU slave address (default: 1)
- REG_TEMPERATURE: Holding register address for temperature (default: 0)
- REG_HUMIDITY: Holding register address for humidity (default: 1)
- REG_SAMPLE_INTERVAL: Holding register address for sample interval in seconds (default: 2)
- SCALE_TEMPERATURE: Scaling factor for temperature (default: 0.01)
- SCALE_HUMIDITY: Scaling factor for humidity (default: 0.01)
- POLL_USE_SAMPLE_INTERVAL: Use the sensor’s sample-interval register for polling cadence (true/false, default: true)
- POLL_INTERVAL_SEC: Fallback polling interval in seconds when not using sample interval (default: 2)
- RETRY_MAX: Max retries per polling cycle on errors (default: 3)
- BACKOFF_BASE_MS: Base backoff in milliseconds for retries (default: 200)
- BACKOFF_MAX_MS: Max backoff in milliseconds for retries/connection attempts (default: 5000)
- READ_TIMEOUT_MS: Overall timeout for each Modbus transaction (default: 1000)
- LOG_LEVEL: Log level (debug/info/warn/error, default: info)

Build and Run
- Ensure Go (1.21+) is installed.
- Set environment variables as needed.
- Build: go build -o ths-driver
- Run: ./ths-driver

Example
- Run the driver then query the status:
  curl http://localhost:8080/status

API
- GET /status: Returns JSON with connection status (serial and Modbus), last sample values (temperature °C, humidity %RH, sample interval s), error counters (timeouts, CRC errors, retries, reconnects), and timestamps (last poll attempt, last successful read, last error). This endpoint serves the latest buffered data without triggering new Modbus transactions.

Notes
- This driver reads the three registers individually or in one contiguous block if they are sequential. The sample interval is clamped to 1–60 seconds.
- Supported default serial format: 8 data bits, No parity, 1 stop bit (configurable).

Generated by [IoT Driver Copilot](https://copilot.test.shifu.dev/)
